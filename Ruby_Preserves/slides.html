<!DOCTYPE html>
<html>
  <head>
    <title>Ruby Preserves</title>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
    <style type="text/css">
      @import url(https://fonts.googleapis.com/css?family=Yanone+Kaffeesatz);
      @import url(https://fonts.googleapis.com/css?family=Droid+Serif:400,700,400italic);
      @import url(https://fonts.googleapis.com/css?family=Ubuntu+Mono:400,700,400italic);

      body {
        font-family: 'Droid Serif';
      }
      footer {
        display: block;
        bottom: 0;
        position: absolute;
        color: #888;
        margin-bottom: -10px;
        margin-left: -90px;
        font-size: 20px;
      }
      h1, h2, h3 {
        font-family: 'Yanone Kaffeesatz';
        font-weight: normal;
      }
      .remark-slides-area { background-color: #9B111E; }
      .remark-slide-content {
        font-size: 26px; line-height: 1.6;
      }
      .remark-slide-number { font-size: 18px; }
      .remark-code, .remark-inline-code { font-family: 'Ubuntu Mono'; }
      .remark-slide .title li {
        list-style-type: none;
        font-size: 28px;
      }
      .remark-slide .title ul {
        padding-left: 0px;
      }
      .remark-slide .title h1 {
        font-size: 60px;
      }
      .remark-slide li p {
        margin: 0;
      }
      a {
        text-decoration: none;
        border-bottom: 1px #666666 dashed;
        color: #202;
      }
      a:hover {
        color: #505;
        background-color: #DD0;
      }

    </style>
  </head>
  <body>
    <textarea id="source">
class: title, middle, center

# Ruby Preserves

* by Craig Buchek


* STL Ruby
* October 12, 2015


http://tinyurl.com/ruby_preserves_stl


---
layout: true

<footer>
  <p>@CraigBuchek</p>
</footer>

---

About Me
========

* Independent web developer
    * [BoochTek][boochtek]
* Ruby / Rails programmer since 2006
* Agile practitioner
    * [This Agile Life][tal] podcast
* Boring slide designer

---

ORM
===

* Object-Relational Mapper (ORM)


* Connects your app to your database


* Ruby - objects
* SQL - relations

???

* SQL databases deal with relations
  * Relational algebra
* Ruby deals with objects
* Caveat: there's an "impedance mismatch" between the 2 sides

---

ActiveRecord
============

* Ubiquitous
    * Everyone knows it
    * Lots of people improving it
    * Plugins usually assume you're using it
    * Documentation
* Well-tested
* Well-understood
* Easy to use - it comes with Rails

???

* Who loves ActiveRecord?
* Who hates ActiveRecord?
* Who raised their hand both times?
* Who has had to manually type SQL in an ActiveRecord class?
    * So ActiveRecord is a leaky abstraction
        * SQL leaked up into the upper layers of abstraction
* Who thinks it's crazy to have to look at the class for relationships, but the schema for other attributes?
* I hate ActiveRecord - mostly
* But ActiveRecord is the 800-pount gorilla
* Odds are, if you're hired to work on Rails, you'll be using AR

---

Active Record Pattern
=====================

* Domain logic and persistence logic in same class
* Violates SRP (Single Responsibility Principle)


* ActiveRecord ORM uses this pattern

???

* The biggest problem with AR is that it encourages bad engineering habits
    * This is mostly because it violates the SRP
* Note "Active Record" is the pattern and "ActiveRecord" is the ORM
* Active Record pattern described by Martin Fowler
    * [Patterns of Enterprise Application Architecture][peap]
* Separation of concerns in important
    * Just like Rails separates M-V-C concerns
    * But ActiveRecord does a terrible job at it
* My experience is that the sweet spot for AR is about 20 model classes
    * Data Mapper pattern has a little more overhead in the number of classes/concepts
        * Pays off a lot as you have more classes
        * Still has a couple advantages with only a few classes

---

Data Mapper Pattern
===================

* Maps between domain objects and the database
* Domain objects don't have to know anything about the database or its schema
* DB schema and model object structure can differ
    * DB schema can change without having to change domain objects
        * Only the mapper changes

???

* Note that the DataMapper Ruby gem didn't actually use the Data Mapper pattern
    * It used the Active Record pattern
* Python's SQL Alchemy uses the Data Mapper pattern
    * This library is very highly regarded --- basically *the* Python ORM

---

Repository Pattern
==================

* Represents a collection of domain objects

???

* In ActiveRecord, the class methods often act as the repository
    * But you can't easily have 2 repositories for the same model class with different data stores
    * Class methods are generally problematic
         * Hard to test

---

Repository Architecture
=======================

* Domain model class handles business logic
* Repository class handles persistence
* Mapper class handles mapping database fields to object attributes

???

* We have a clear separation of concerns
* Sometimes we'll call the domain models entities
    * From [Domain-Driven Design][ddd] book
    * Entities implies that the object is defined by its ID

---

Ruby Preserves
==============

Trying to answer 3 questions:

* How simple can we make an ORM that is still useful?
* Developers have to know SQL anyway, so why try to hide the SQL from them?
    * Is the complexity of a typical ORM really better than the complexity of SQL?
* ORMs are a leaky abstraction. What if we made it so leaky that it doesn't matter?

---

Ruby Preserves
==============

Opinions:

* Data Mapper pattern is better than the Active Record pattern
    * Unless you're just writing a CRUD front-end, with little interesting behavior
* Declaring attributes in the domain model is better than hiding them elsewhere
    * Declaring relationships in one place and attributes in another is true madness
* NoSQL as a main data store is usually misguided
    * PostgreSQL can do just about anything you need, using SQL
* Projects are unlikely to need to abstract SQL to allow them to use different RDBMSes
    * Developer workstations are fast enough to run "full" RDBMSes
    * If you're not using "interesting" features, then you're probably using "standard" SQL

---

Domain Model
============

* Can use a Struct, an OStruct, a Virtus model, or a PORO class


~~~ ruby
User = Struct.new(:id, :name, :age) do
end

craig = User.new("booch", "Craig", 44)
~~~

???

* PORO = plain old Ruby object
* Note that I can create my model with no database involved

---

Data Mapping
============

~~~ ruby
UserRepository = Preserves.repository(model: User) do
  mapping do
    # The database field named 'username' corresponds to the 'id' attribute in the model.
    map id: 'username'
    # The 'age' field should be mapped to an Integer in the model.
    map :age, Integer
  end
end
~~~

---

Repository Methods
==================

~~~ ruby
UserRepository = Preserves.repository(model: User) do
  def insert(user)
    result = query("INSERT INTO 'users' (username, name, age) VALUES (?, ?, ?)",
                   user.id, user.name, user.age)
    raise "Could not insert User #{user.id} into database" unless result.rows == 1
  end

  def older_than(age)
    select("SELECT *, username AS id FROM 'users' WHERE age > ? ORDER BY ?", age, :name)
  end

  def with_id(id)
    select("SELECT *, username AS id FROM 'users' WHERE username = ?", id)
  end
end
~~~

---

Advantages
==========

* Domain class contains everything you need to know
    * Don't have to look elsewhere to understand everything a class contains
* Better meets the Single Responsibility Principle (SRP)
* Small, easy to understand
* Encourages better separation of concerns
* Encourages better understanding of SQL
* Experimentation / learning

---

Further Work
============

* Optimizations / caching
    * Prepared statements
* Automatically determine mappings, where possible
    * Virtus model attribute definitions
    * Database schema
* Add a layer to write the SQL for us

---

Alternatives
============

1. Lotus::Model
2. Perpetuity
3. ROM
4. Sequel
5. ActiveRecord with declared attributes

???

* Ruby Preserves is nowhere near ready for production
* I still don't have an ORM I'm really happy with
* This is the order I'd currently consider them, for my personal projects
    * Obviously, context matters a lot

---

Further Info
============

* [The State of Ruby ORM][state-of-orm] (2011)
* [DataMapper Retrospective][datamapper-retro] (2011)
* [Sequel is awesome and much better than ActiveRecord][sequel-awesome]
* [Why You Should Never Use MongoDB][no-mongo] (Sarah Mei)
* [ORM Hate][orm-hate] (Martin Fowler)
* [Data Mapper vs Active Record][dm-v-ar]
* [Turning the Tables: How to Get Along with your Object-Relational Mapper][turning-tables]

---

Colophon
========

* [Remark][remark] - JavaScript slide show from Markdown

---

Feedback
========

* Twitter: [@CraigBuchek][twitter]
* GitHub: [booch][github]
* Email: craig@boochtek.com


* Project: https://github.com/boochtek/ruby_preserves


* Slides: http://tinyurl.com/ruby_preserves_stl
* Slides: https://github.com/booch/presentations/



[rr-222]: http://devchat.cachefly.net/rubyrogues/transcript-222-rr-rails-5-with-sean-griffin-ruby-rogues.pdf
[peap]: http://www.amazon.com/dp/0321127420
[ddd]: http://www.amazon.com/dp/0321125215
[no-mongo]: http://www.sarahmei.com/blog/2013/11/11/why-you-should-never-use-mongodb/
[state-of-orm]: http://solnic.eu/2011/11/29/the-state-of-ruby-orm.html
[datamapper-retro]: http://rhnh.net/2011/11/29/datamapper-retrospective
[sequel-awesome]: http://rosenfeld.herokuapp.com/en/articles/ruby-rails/2013-12-18-sequel-is-awesome-and-much-better-than-activerecord
[orm-hate]: http://java.dzone.com/articles/martin-fowler-orm-hate
[dm-v-ar]: http://jgaskins.org/blog/2012/04/20/data-mapper-vs-active-record/
[turning-tables]: https://medium.com/@bradurani/turning-the-tables-how-to-get-along-with-your-object-relational-mapper-e5d2d6a76573


[twitter]: https://twitter.com/CraigBuchek
[github]: https://github.com/booch
[github-boochtek]: https://github.com/boochtek
[boochtek]: http://boochtek.com
[tal]: http://www.thisagilelife.com


[remark]: http://remarkjs.com/

    </textarea>
    <!-- <script src="https://gnab.github.io/remark/downloads/remark-latest.min.js"> -->
    <script src="remark-latest.min.js">
    </script>
    <script>
      var slideshow = remark.create();
      for (i = 0; slide = slideshow.getSlides[i]; )
      {
        slide.properties.class = "middle, center";
      }
    </script>
  </body>
</html>
